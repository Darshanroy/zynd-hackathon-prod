<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="utf-8" />
    <meta content="width=device-width, initial-scale=1.0" name="viewport" />
    <title>Chat with Sahayak | Jan Sahayak</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Public+Sans:wght@300;400;500;600;700;800;900&amp;display=swap"
        rel="stylesheet" />
    <link
        href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&amp;display=swap"
        rel="stylesheet" />
    <script>
        tailwind.config = {
            darkMode: "class",
            theme: {
                extend: {
                    colors: {
                        "primary": "#1b203b",
                        "accent-blue": "#005EA2",
                        "background-light": "#f6f6f7",
                        "background-dark": "#15161d",
                        "gov-gray": "#f0f0f0",
                    },
                    fontFamily: {
                        "display": ["Public Sans", "sans-serif"],
                        "sans": ["Public Sans", "sans-serif"]
                    },
                    animation: {
                        'gradient-x': 'gradient-x 15s ease infinite',
                    },
                    keyframes: {
                        'gradient-x': {
                            '0%, 100%': {
                                'background-size': '200% 200%',
                                'background-position': 'left center'
                            },
                            '50%': {
                                'background-size': '200% 200%',
                                'background-position': 'right center'
                            },
                        }
                    }
                },
            },
        }
    </script>
    <style>
        body {
            font-family: 'Public Sans', sans-serif;
        }

        .material-symbols-outlined {
            font-variation-settings: 'FILL' 0, 'wght' 400, 'GRAD' 0, 'opsz' 24;
        }

        /* Chat Bubble Styles */
        .chat-bubble {
            max-width: 85%;
            padding: 1.25rem;
            margin-bottom: 1.5rem;
            line-height: 1.6;
            position: relative;
            box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1), 0 2px 4px -2px rgb(0 0 0 / 0.1);
        }

        .user-bubble {
            background-image: linear-gradient(to bottom right, #005EA2, #1d4ed8);
            color: white;
            align-self: flex-end;
            border-radius: 1.25rem 1.25rem 0.25rem 1.25rem;
        }

        .bot-bubble {
            background-color: white;
            border: 1px solid #f1f5f9;
            color: #1e293b;
            align-self: flex-start;
            border-radius: 1.25rem 1.25rem 1.25rem 0.25rem;
        }

        .bot-bubble.streaming {
            border-left: 4px solid #005EA2;
        }

        /* Markdown Content Styles inside Bubble */
        .bot-bubble h1,
        .bot-bubble h2,
        .bot-bubble h3 {
            margin-top: 1rem;
            margin-bottom: 0.5rem;
            font-weight: 700;
            color: #1b203b;
        }

        .bot-bubble h2 {
            font-size: 1.1rem;
        }

        .bot-bubble h3 {
            font-size: 1rem;
        }

        .bot-bubble ul {
            list-style-type: disc;
            padding-left: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .bot-bubble ol {
            list-style-type: decimal;
            padding-left: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .bot-bubble p {
            margin-bottom: 0.75rem;
        }

        .bot-bubble strong {
            font-weight: 600;
        }

        .bot-bubble a {
            color: #005EA2;
            text-decoration: underline;
        }

        /* Loading Indicator */
        .typing-indicator {
            display: inline-flex;
            align-items: center;
            gap: 4px;
        }

        .typing-dot {
            width: 6px;
            height: 6px;
            background-color: #94a3b8;
            border-radius: 50%;
            animation: bounce 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) {
            animation-delay: -0.32s;
        }

        .typing-dot:nth-child(2) {
            animation-delay: -0.16s;
        }

        @keyframes bounce {

            0%,
            80%,
            100% {
                transform: scale(0);
            }

            40% {
                transform: scale(1);
            }
        }

        /* Status Logs */
        .status-log {
            font-size: 0.75rem;
            color: #64748b;
            margin-bottom: 0.25rem;
            font-family: monospace;
            padding-left: 0.5rem;
            border-left: 2px solid #cbd5e1;
        }

        /* Dark Mode Overrides */
        .dark .bot-bubble {
            background-color: #1e293b;
            border-color: #334155;
            color: #f1f5f9;
        }

        .dark .bot-bubble h1,
        .dark .bot-bubble h2,
        .dark .bot-bubble h3 {
            color: white;
        }

        .dark .bot-bubble a {
            color: #60a5fa;
        }

        .dark .status-log {
            color: #94a3b8;
            border-left-color: #475569;
        }
    </style>
    <script>
        if (localStorage.theme === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.documentElement.classList.add('dark');
        } else {
            document.documentElement.classList.remove('dark');
        }

        function toggleDarkMode() {
            if (document.documentElement.classList.contains('dark')) {
                document.documentElement.classList.remove('dark');
                localStorage.theme = 'light';
            } else {
                document.documentElement.classList.add('dark');
                localStorage.theme = 'dark';
            }
        }
    </script>
</head>

<body
    class="bg-gradient-to-br from-background-light via-blue-50 to-white dark:from-slate-900 dark:via-[#0b1021] dark:to-slate-900 animate-gradient-x text-slate-800 dark:text-slate-200 text-base md:text-lg leading-relaxed antialiased h-screen flex flex-col transition-colors duration-500 relative">

    <!-- Background Decor -->
    <div class="absolute inset-0 overflow-hidden pointer-events-none z-0">
        <div
            class="absolute top-0 right-0 w-[500px] h-[500px] bg-accent-blue/5 dark:bg-accent-blue/10 rounded-full blur-[100px]">
        </div>
    </div>

    <!-- Header (Condensed) -->
    <header
        class="bg-primary/95 backdrop-blur-md text-white shadow-xl flex-none border-b border-white/10 relative z-20">
        <div class="max-w-7xl mx-auto px-6 h-16 flex items-center justify-between">
            <div class="flex items-center gap-3 cursor-pointer group" onclick="window.location.href='/'">
                <div class="bg-white/10 p-1.5 rounded text-white group-hover:bg-white/20 transition-colors">
                    <span class="material-symbols-outlined text-xl">assured_workload</span>
                </div>
                <h1 class="text-lg font-extrabold tracking-tight">Jan Sahayak Chat</h1>
            </div>
            <div class="flex items-center gap-4">
                <button onclick="clearChat()" aria-label="Clear Chat History"
                    class="text-sm font-medium text-slate-300 hover:text-white focus:outline-none focus:ring-2 focus:ring-white/50 rounded px-2 py-1 transition-colors flex items-center gap-1"
                    title="Clear Chat History">
                    <span class="material-symbols-outlined text-sm">delete</span> Clear
                </button>
                <div class="w-px h-4 bg-slate-600"></div>
                <button onclick="toggleDarkMode()" aria-label="Toggle Dark Mode"
                    class="w-9 h-9 flex items-center justify-center rounded-full text-white hover:bg-white/10 focus:outline-none focus:ring-2 focus:ring-white/50 transition-colors"
                    title="Toggle Dark Mode">
                    <span class="material-symbols-outlined dark:hidden">dark_mode</span>
                    <span class="material-symbols-outlined hidden dark:block">light_mode</span>
                </button>
                <button onclick="window.location.href='/'"
                    class="text-sm font-medium hover:text-slate-300 focus:outline-none focus:ring-2 focus:ring-white/50 rounded px-2 py-1 transition-colors">Exit
                    Chat</button>
            </div>
        </div>
    </header>

    <!-- Login Modal -->
    <div id="login-modal"
        class="fixed inset-0 bg-slate-900/60 dark:bg-slate-900/80 backdrop-blur-sm z-50 flex items-center justify-center">
        <div
            class="bg-white/90 dark:bg-slate-800/90 backdrop-blur-xl rounded-2xl shadow-2xl p-8 max-w-md w-full mx-4 border border-white/20 dark:border-slate-700 relative overflow-hidden">

            <div
                class="absolute -top-20 -right-20 w-40 h-40 bg-accent-blue/10 rounded-full blur-2xl pointer-events-none">
            </div>

            <div class="text-center mb-8 relative z-10">
                <div
                    class="bg-gradient-to-br from-primary to-accent-blue w-16 h-16 rounded-full flex items-center justify-center mx-auto mb-4 shadow-lg border-2 border-white/20">
                    <span class="material-symbols-outlined text-white text-3xl">lock</span>
                </div>
                <h2 class="text-3xl font-black text-slate-900 dark:text-white tracking-tight">Welcome to Jan Sahayak
                </h2>
                <p class="text-slate-500 dark:text-slate-400 mt-2 text-sm leading-relaxed">Please verify your details to
                    access your secure chat
                    history.</p>
            </div>

            <form id="login-form" class="space-y-4" onsubmit="handleLogin(event)">
                <div>
                    <label
                        class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2 uppercase tracking-wide">Full
                        Name</label>
                    <input type="text" id="user-name" required
                        class="w-full h-12 rounded-xl border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-900/50 focus:ring-4 focus:ring-accent-blue/20 dark:focus:ring-blue-500/20 focus:border-accent-blue transition-all"
                        placeholder="e.g. Rahul Kumar">
                </div>
                <div>
                    <label
                        class="block text-sm font-bold text-slate-700 dark:text-slate-300 mb-2 uppercase tracking-wide">Phone
                        Number</label>
                    <input type="tel" id="user-phone" required pattern="[0-9]{10}"
                        class="w-full h-12 rounded-xl border border-slate-300 dark:border-slate-600 bg-slate-50 dark:bg-slate-900/50 focus:ring-4 focus:ring-accent-blue/20 dark:focus:ring-blue-500/20 focus:border-accent-blue transition-all"
                        placeholder="e.g. 9876543210 (10 digits)">
                </div>
                <button type="submit"
                    class="w-full bg-gradient-to-r from-accent-blue to-primary text-white h-14 mt-4 rounded-xl font-bold hover:shadow-[0_8px_30px_-10px_rgba(0,94,162,0.8)] hover:-translate-y-0.5 transition-all flex items-center justify-center gap-2 group">
                    <span>Start Chatting</span>
                    <span
                        class="material-symbols-outlined text-sm group-hover:translate-x-1 transition-transform">arrow_forward</span>
                </button>
            </form>
        </div>
    </div>

    <!-- Chat Area -->
    <main
        class="flex-grow overflow-hidden flex flex-col max-w-5xl mx-auto w-full bg-white/70 dark:bg-slate-900/70 backdrop-blur-xl shadow-2xl my-0 md:my-6 rounded-none md:rounded-2xl border border-white/40 dark:border-slate-700 relative z-10">

        <!-- Messages Container -->
        <div id="chat-messages" class="flex-grow overflow-y-auto p-4 md:p-8 flex flex-col gap-2">
            <!-- Welcome Message (Will be added dynamically if no history) -->
        </div>

        <!-- Input Area -->
        <div
            class="p-4 md:p-6 bg-white/40 dark:bg-slate-800/40 backdrop-blur-lg border-t border-slate-200/50 dark:border-slate-700/50 flex-none rounded-b-2xl">
            <div
                class="relative flex items-end gap-3 max-w-4xl mx-auto bg-white dark:bg-slate-900 border border-slate-200 dark:border-slate-700 rounded-2xl p-2 shadow-sm focus-within:ring-4 focus-within:ring-accent-blue/10 dark:focus-within:ring-blue-500/10 focus-within:border-accent-blue transition-all">
                <textarea id="user-input" rows="1"
                    class="w-full resize-none bg-transparent border-0 px-4 py-3 focus:ring-0 text-slate-900 dark:text-slate-100 max-h-32 placeholder:text-slate-400"
                    placeholder="Type your question here..."
                    oninput="this.style.height = ''; this.style.height = this.scrollHeight + 'px'"
                    onkeydown="if(event.key === 'Enter' && !event.shiftKey) { event.preventDefault(); sendMessage(); }"></textarea>
                <button id="send-btn" onclick="sendMessage()" aria-label="Send Message"
                    class="bg-accent-blue text-white w-12 h-12 mb-0.5 rounded-xl hover:bg-blue-600 focus:outline-none focus:ring-4 focus:ring-accent-blue/50 transition-colors flex-none flex items-center justify-center shadow-md disabled:opacity-50 disabled:cursor-not-allowed group">
                    <span class="material-symbols-outlined group-hover:translate-x-0.5 transition-transform">send</span>
                </button>
            </div>
            <p class="text-[11px] text-center text-slate-400 dark:text-slate-500 mt-3 font-medium tracking-wide">Jan
                Sahayak can make mistakes. Always verify important information with official sources.</p>
        </div>
    </main>

    <script>
        let threadId = null;
        let userName = null;

        const loginModal = document.getElementById('login-modal');
        const chatContainer = document.getElementById('chat-messages');
        const userInput = document.getElementById('user-input');
        const sendBtn = document.getElementById('send-btn');
        let isGenerating = false;

        // Check for existing session
        window.addEventListener('load', () => {
            const storedPhone = localStorage.getItem('jan_sahayak_phone');
            const storedName = localStorage.getItem('jan_sahayak_name');

            if (storedPhone && storedName) {
                document.getElementById('user-phone').value = storedPhone;
                document.getElementById('user-name').value = storedName;
                // Auto-login logic could go here, but requiring click is safer for demo
            }
        });

        async function handleLogin(e) {
            e.preventDefault();
            const phone = document.getElementById('user-phone').value;
            const name = document.getElementById('user-name').value;

            if (phone && name) {
                threadId = phone; // Use phone as thread ID
                userName = name;

                // Save to local storage
                localStorage.setItem('jan_sahayak_phone', phone);
                localStorage.setItem('jan_sahayak_name', name);

                // Hide Modal
                loginModal.style.display = 'none';

                // Load History
                await loadChatHistory();
            }
        }

        async function loadChatHistory() {
            try {
                const res = await fetch('/api/get-chat-history', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ thread_id: threadId })
                });
                const data = await res.json();

                chatContainer.innerHTML = ''; // Clear container

                if (data.messages && data.messages.length > 0) {
                    data.messages.forEach(msg => {
                        appendMessage(msg.role === 'user' ? 'user' : 'bot', msg.content);
                    });

                    // Add "Welcome Back" system notice
                    const notice = document.createElement('div');
                    notice.className = 'text-center text-xs text-slate-400 my-4';
                    notice.textContent = `Welcome back, ${userName}! History loaded.`;
                    chatContainer.appendChild(notice);
                } else {
                    // Show Default Welcome
                    const welcomeDiv = document.createElement('div');
                    welcomeDiv.className = 'chat-bubble bot-bubble shadow-sm';
                    welcomeDiv.innerHTML = `<p><strong>Namaste ${userName}!</strong> I am your Jan Sahayak.</p>
                        <p>I can help you understand policies, check eligibility for schemes, or guide you through application processes.</p>
                        <p>How can I assist you today?</p>`;
                    chatContainer.appendChild(welcomeDiv);
                }
                scrollToBottom();
            } catch (err) {
                console.error("Failed to load history:", err);
            }
        }

        function scrollToBottom() {
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }

        async function clearChat() {
            if (!threadId) return;
            if (confirm('Are you sure you want to clear your chat history?')) {
                try {
                    // Call backend to clear the LangGraph checkpoint memory
                    const res = await fetch('/api/clear-chat', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ thread_id: threadId })
                    });
                    const data = await res.json();

                    if (res.ok) {
                        chatContainer.innerHTML = '';

                        const welcomeDiv = document.createElement('div');
                        welcomeDiv.className = 'chat-bubble bot-bubble shadow-sm';
                        welcomeDiv.innerHTML = `<p><strong>Namaste ${userName}!</strong> Your chat history has been cleared.</p>
                            <p>I can help you understand policies, check eligibility for schemes, or guide you through application processes.</p>
                            <p>How can I assist you today?</p>`;
                        chatContainer.appendChild(welcomeDiv);
                    } else {
                        throw new Error(data.error || "Failed to clear chat");
                    }
                } catch (e) {
                    console.error("Error clearing chat", e);
                    alert("Oops, couldn't clear chat history: " + e.message);
                }
            }
        }

        function appendMessage(role, text) {
            const div = document.createElement('div');
            div.className = `chat-bubble ${role === 'user' ? 'user-bubble' : 'bot-bubble'} shadow-sm`;

            if (role === 'bot') {
                const contentDiv = document.createElement('div');
                contentDiv.className = 'markdown-body';
                contentDiv.innerHTML = marked.parse(text);
                div.appendChild(contentDiv);
            } else {
                div.textContent = text;
            }

            chatContainer.appendChild(div);
            scrollToBottom();
            return div;
        }

        async function sendMessage() {
            const text = userInput.value.trim();
            if (!text || isGenerating) return;

            // Reset UI
            userInput.value = '';
            userInput.style.height = 'auto';
            isGenerating = true;
            sendBtn.disabled = true;

            // Append User Message
            appendMessage('user', text);

            // Create Placeholder for Bot Response
            const botDiv = document.createElement('div');
            botDiv.className = 'chat-bubble bot-bubble streaming shadow-sm w-full';
            chatContainer.appendChild(botDiv);
            scrollToBottom();

            // Logs Container inside bot message (initially visible)
            const logsDiv = document.createElement('div');
            logsDiv.className = 'mb-2';
            botDiv.appendChild(logsDiv);

            // Content Container
            const contentDiv = document.createElement('div');
            contentDiv.className = 'markdown-body'; // Using custom styles
            botDiv.appendChild(contentDiv);

            try {
                const response = await fetch('/api/submit-query', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        selected_option: 'chat',
                        query: text,
                        thread_id: threadId // Send Phone Number as Thread ID
                    })
                });

                const reader = response.body.getReader();
                const decoder = new TextDecoder();
                let fullResponse = "";

                while (true) {
                    const { done, value } = await reader.read();
                    if (done) break;

                    const chunk = decoder.decode(value, { stream: true });
                    const lines = chunk.split("\n\n");

                    for (const line of lines) {
                        if (line.startsWith("data: ")) {
                            try {
                                const data = JSON.parse(line.slice(6));

                                if (data.type === 'log') {
                                    // Add log status
                                    const logItem = document.createElement('div');
                                    logItem.className = 'status-log';
                                    logItem.textContent = data.message;
                                    logsDiv.appendChild(logItem);
                                    scrollToBottom();
                                } else if (data.type === 'result') {
                                    // Use the final response if provided here
                                    if (data.response) {
                                        fullResponse = data.response;
                                        contentDiv.innerHTML = marked.parse(fullResponse);
                                    }
                                    botDiv.classList.remove('streaming');
                                    // Optionally hide logs after completion or keep them for transparency
                                    // logsDiv.style.display = 'none'; 
                                } else if (data.type === 'redirect') {
                                    // Fallback for logic if redirect event type is used
                                    if (data.response) {
                                        fullResponse = data.response;
                                        contentDiv.innerHTML = marked.parse(fullResponse);
                                    }
                                    botDiv.classList.remove('streaming');
                                }
                            } catch (e) {
                                console.error("Parse error", e);
                            }
                        }
                    }
                }

            } catch (err) {
                contentDiv.innerHTML = `<p class="text-red-500">Sorry, I encountered an error. Please try again.</p>`;
                console.error(err);
            } finally {
                isGenerating = false;
                sendBtn.disabled = false;
                scrollToBottom();
                userInput.focus();
            }
        }
    </script>
</body>

</html>